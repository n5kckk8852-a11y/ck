<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PC28 ç›‘æ§ Â· Açƒ2è¿æŒ‚é£ä¹¦æé†’</title>
  <style>
    :root{
      --bg:#0b0f17; --muted:#8aa0bf; --text:#e9f1ff;
      --line:rgba(255,255,255,.08);
      --good:#2ee59d; --bad:#ff5d5d; --warn:#ffcc66;
      --btn:#2b6cff; --btn2:#1f2a3d;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", Arial;
      background: radial-gradient(1200px 700px at 20% 0%, #132243 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    .top{display:flex;gap:14px;align-items:flex-end;justify-content:space-between;flex-wrap:wrap;margin-bottom:18px}
    .title{display:flex;flex-direction:column;gap:6px}
    .title h1{margin:0;font-size:20px;letter-spacing:.2px}
    .title p{margin:0;color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr;} }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:16px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{margin:0 0 12px;font-size:14px;color:#cfe2ff;font-weight:650}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input, select{
      width:100%;
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    input:focus, select:focus{border-color: rgba(43,108,255,.7)}
    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{
      border:0;border-radius:12px;padding:10px 12px;cursor:pointer;color:white;
      background: var(--btn);font-weight:650;
    }
    button.secondary{background: var(--btn2); color:#d6e6ff; border:1px solid var(--line)}
    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:10px 12px;
      margin-top:6px;
      font-size:14px;
    }
    .k{color:var(--muted);font-size:12px}
    .v{font-weight:650}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;font-size:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    .good{color:var(--good)}
    .bad{color:var(--bad)}
    .warn{color:var(--warn)}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .log{
      height:240px; overflow:auto; padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-size:12px;
      color:#cfe2ff;
      line-height:1.55;
      white-space:pre-wrap;
    }
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .small{font-size:12px;color:var(--muted);margin-top:10px;line-height:1.6}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">
        <h1>ğŸ¯ PC28 å®æ—¶ç›‘æ§ Â· æŠ¼Açƒï¼ˆ2è¿æŒ‚é£ä¹¦æé†’ï¼‰</h1>
        <p>æ¥å£ï¼š<span class="mono">https://pc28.help/kj.json?limit=0</span>ï¼ˆä» <span class="mono">opennum</span> æ‹† A/B/Cï¼‰</p>
      </div>
      <div class="badge" id="statusBadge">â³ ç­‰å¾…å¯åŠ¨</div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>âš™ï¸ é…ç½®</h2>

        <div class="row">
          <div style="flex:1; min-width:220px">
            <label>é€‰æ‹©æŠ•æ³¨ç›®æ ‡ï¼ˆé»˜è®¤ A çƒï¼‰</label>
            <select id="targetBall">
              <option value="A" selected>A çƒï¼ˆç¬¬1ä¸ªæ•°ï¼‰</option>
              <option value="B">B çƒï¼ˆç¬¬2ä¸ªæ•°ï¼‰</option>
              <option value="C">C çƒï¼ˆç¬¬3ä¸ªæ•°ï¼‰</option>
            </select>
          </div>

          <div style="flex:1; min-width:220px">
            <label>å›ºå®šæŠ•æ³¨æ•°å­—é›†åˆï¼ˆå¦‚ 235687 â†’ æŠ¼ 2/3/5/6/8/7ï¼‰</label>
            <input id="betDigits" value="235687" placeholder="åªå¡« 0-9ï¼Œä¼šè‡ªåŠ¨å»é‡"/>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <div style="flex:1; min-width:220px">
            <label>é£ä¹¦ Webhook URLï¼ˆ2è¿æŒ‚è§¦å‘æ¨é€ï¼‰</label>
            <input id="feishuUrl" placeholder="https://open.feishu.cn/open-apis/bot/v2/hook/xxxx"/>
          </div>

          <div style="flex:1; min-width:220px">
            <label>è½®è¯¢é—´éš”ï¼ˆç§’ï¼‰</label>
            <input id="intervalSec" type="number" min="2" step="1" value="5"/>
          </div>
        </div>

        <div class="btns">
          <button id="startBtn">ğŸš€ å¯åŠ¨</button>
          <button class="secondary" id="stopBtn">ğŸ›‘ åœæ­¢</button>
          <button class="secondary" id="testBtn">ğŸ“¨ æµ‹è¯•é£ä¹¦</button>
          <button class="secondary" id="resetBtn">â™»ï¸ æ¸…çŠ¶æ€</button>
        </div>

        <div class="small">
          âœ… â€œæŒ‚â€åˆ¤å®šï¼šåªçœ‹ä½ é€‰çš„ç›®æ ‡çƒï¼ˆé»˜è®¤ A çƒï¼‰æ˜¯å¦å‘½ä¸­ä½ çš„æ•°å­—é›†åˆã€‚<br/>
          ğŸš¨ è¿ç»­ 2 æœŸæœªå‘½ä¸­ï¼ˆ2è¿æŒ‚ï¼‰â†’ æ¨é€ä¸€æ¬¡ï¼ˆåŒä¸€æœŸåªæ¨ä¸€æ¬¡ï¼‰ã€‚
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“¡ çŠ¶æ€</h2>
        <div class="kv">
          <div class="k">æœ€æ–°æœŸå·</div><div class="v mono" id="issue">-</div>
          <div class="k">opennum</div><div class="v mono" id="opennum">-</div>
          <div class="k">A / B / C</div><div class="v mono" id="abc">-</div>
          <div class="k">æŠ•æ³¨é›†åˆ</div><div class="v mono" id="betSet">-</div>
          <div class="k">ç›®æ ‡çƒ</div><div class="v mono" id="targetShow">A</div>
          <div class="k">æœ¬æœŸç»“æœ</div><div class="v" id="hit">-</div>
          <div class="k">è¿æŒ‚</div><div class="v" id="streak">0</div>
        </div>

        <div class="sep"></div>
        <h2>ğŸ§¾ æ—¥å¿—</h2>
        <div class="log" id="log"></div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2>ğŸ§© æœ€æ–°ä¸€æ¡ raw JSON</h2>
      <div class="log mono" id="rawJson"></div>
    </div>
  </div>

<script>
(() => {
  const API = "https://pc28.help/kj.json?limit=0";

  const $ = (id) => document.getElementById(id);

  const el = {
    badge: $("statusBadge"),
    targetBall: $("targetBall"),
    betDigits: $("betDigits"),
    feishuUrl: $("feishuUrl"),
    intervalSec: $("intervalSec"),
    issue: $("issue"),
    opennum: $("opennum"),
    abc: $("abc"),
    betSet: $("betSet"),
    targetShow: $("targetShow"),
    hit: $("hit"),
    streak: $("streak"),
    log: $("log"),
    rawJson: $("rawJson"),
    startBtn: $("startBtn"),
    stopBtn: $("stopBtn"),
    testBtn: $("testBtn"),
    resetBtn: $("resetBtn"),
  };

  const LS = {
    streak: "pc28_ball_streak",
    lastIssue: "pc28_ball_lastIssue",
    lastPushedIssue: "pc28_ball_lastPushedIssue",
    feishuUrl: "pc28_ball_feishuUrl",
    betDigits: "pc28_ball_betDigits",
    intervalSec: "pc28_ball_intervalSec",
    targetBall: "pc28_ball_targetBall",
  };

  let timer = null;

  function now() {
    const d = new Date();
    const pad = (n) => String(n).padStart(2, "0");
    return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  function log(msg) { el.log.textContent = `[${now()}] ${msg}\n` + el.log.textContent; }
  function setBadge(type, text) {
    el.badge.className = "badge";
    if (type === "good") el.badge.classList.add("good");
    if (type === "bad") el.badge.classList.add("bad");
    if (type === "warn") el.badge.classList.add("warn");
    el.badge.textContent = text;
  }

  function parseBetDigits(str) {
    const digits = (str || "").match(/\d/g) || [];
    const set = [...new Set(digits.map(d => Number(d)))].filter(n => n >= 0 && n <= 9);
    return set.sort((a,b)=>a-b);
  }

  function pick(obj, keys) {
    for (const k of keys) {
      if (obj && Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null) return obj[k];
    }
    return null;
  }

  function toABCFromOpenNum(opennum) {
    // å…¼å®¹ "6+9+3" / "6,9,3" / "06 09 03" ç­‰
    if (opennum == null) return {A:null,B:null,C:null};
    const s = String(opennum);
    const nums = s.match(/\d+/g);
    if (!nums || nums.length < 3) return {A:null,B:null,C:null};
    const arr = nums.slice(0,3).map(Number);
    if (arr.some(n => !Number.isFinite(n))) return {A:null,B:null,C:null};
    return {A:arr[0],B:arr[1],C:arr[2]};
  }

  function normalizeLatest(payload) {
    // çœŸå®æ¥å£ï¼š{"data":[{"qihao":"...","opennum":"6+9+3","sum":"18"}],"message":"success"}
    const item =
      (payload && payload.data && Array.isArray(payload.data) && payload.data[0]) ? payload.data[0] :
      (Array.isArray(payload) ? payload[0] :
      (payload && typeof payload === "object" ? payload : null));

    if (!item || typeof item !== "object") return null;

    const issue = String(pick(item, ["qihao","issue","expect","period","id"]) ?? "-");
    const opennum = pick(item, ["opennum","open","opencode","code","kj","result","numbers","num"]) ?? "-";

    const {A,B,C} = toABCFromOpenNum(opennum);

    return { issue, opennum: String(opennum), A, B, C, _rawItem: item };
  }

  async function feishuPush(url, text) {
    const body = { msg_type: "text", content: { text } };
    const resp = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    if (!resp.ok) {
      const t = await resp.text().catch(()=> "");
      throw new Error(`HTTP ${resp.status} ${t}`.trim());
    }
  }

  async function tick() {
    try {
      const betSet = parseBetDigits(el.betDigits.value);
      el.betSet.textContent = betSet.join("") || "-";

      const target = el.targetBall.value || "A";
      el.targetShow.textContent = target;

      const resp = await fetch(API, { cache: "no-store" });
      const payload = await resp.json();

      const latest = normalizeLatest(payload);
      if (!latest) {
        setBadge("bad","âŒ è§£æå¤±è´¥");
        log("âŒ æ— æ³•è§£ææ¥å£ï¼ˆçœ‹ raw JSONï¼‰");
        el.rawJson.textContent = JSON.stringify(payload, null, 2);
        return;
      }

      el.rawJson.textContent = JSON.stringify(latest._rawItem, null, 2);
      el.issue.textContent = latest.issue;
      el.opennum.textContent = latest.opennum;
      el.abc.textContent =
        (latest.A==null || latest.B==null || latest.C==null) ? "-" : `${latest.A} / ${latest.B} / ${latest.C}`;

      const lastIssue = localStorage.getItem(LS.lastIssue) || "";
      const isNew = latest.issue !== lastIssue;

      const ballValue = latest[target];
      if (ballValue == null || !Number.isFinite(ballValue)) {
        el.hit.innerHTML = `<span class="warn">âš ï¸ ç¼ºå°‘ ${target} çƒï¼Œæ— æ³•åˆ¤æ–­</span>`;
        setBadge("warn","âš ï¸ è¿è¡Œä¸­ï¼šç¼ºå­—æ®µ");
        if (isNew) localStorage.setItem(LS.lastIssue, latest.issue);
        return;
      }

      const hit = betSet.includes(ballValue);

      let streak = Number(localStorage.getItem(LS.streak) || "0");
      if (isNew) {
        streak = hit ? 0 : (streak + 1);
        localStorage.setItem(LS.streak, String(streak));
        localStorage.setItem(LS.lastIssue, latest.issue);
        log(`${hit ? "âœ… å‘½ä¸­" : "âŒ æŒ‚"}ï½œæœŸå· ${latest.issue}ï½œ${target}çƒ=${ballValue}ï½œæŠ•æ³¨=${betSet.join("") || "-"}ï½œè¿æŒ‚=${streak}`);
      }

      el.streak.textContent = String(streak);
      el.hit.innerHTML = hit
        ? `<span class="good">âœ… å‘½ä¸­ï¼ˆ${target}çƒ=${ballValue}ï¼‰</span>`
        : `<span class="bad">âŒ æŒ‚ï¼ˆ${target}çƒ=${ballValue}ï¼‰</span>`;

      if (hit) setBadge("good","âœ… è¿è¡Œä¸­ï¼šå‘½ä¸­");
      else if (streak >= 2) setBadge("bad","ğŸš¨ 2è¿æŒ‚è§¦å‘");
      else setBadge("warn","âš ï¸ è¿è¡Œä¸­ï¼šæœªå‘½ä¸­");

      // 2è¿æŒ‚æ¨é€ï¼šåŒä¸€æœŸåªæ¨ä¸€æ¬¡
      if (!hit && streak >= 2) {
        const url = (el.feishuUrl.value || "").trim();
        if (!url) { log("ğŸš« å·²è¾¾ 2è¿æŒ‚ï¼Œä½†æœªå¡«é£ä¹¦ URLï¼Œè·³è¿‡æ¨é€"); return; }

        const lastPushed = localStorage.getItem(LS.lastPushedIssue) || "";
        if (lastPushed === latest.issue) return;

        const msg =
`ğŸš¨ã€${target}çƒ 2è¿æŒ‚é¢„è­¦ã€‘ğŸš¨
æœŸå·ï¼š${latest.issue}
opennumï¼š${latest.opennum}
A/B/Cï¼š${el.abc.textContent}

ğŸ¯ ä½ çš„${target}çƒå›ºå®šæŠ•æ³¨ï¼š${betSet.join("") || "-"}
âŒ æœ¬æœŸ${target}çƒï¼š${ballValue}

ğŸ“‰ å½“å‰è¿æŒ‚ï¼š${streak}`;

        try {
          await feishuPush(url, msg);
          localStorage.setItem(LS.lastPushedIssue, latest.issue);
          log("ğŸ“¨ é£ä¹¦æ¨é€æˆåŠŸ âœ…ï¼ˆ2è¿æŒ‚è§¦å‘ï¼‰");
        } catch (e) {
          log("âŒ é£ä¹¦æ¨é€å¤±è´¥ï¼š" + (e?.message || e));
        }
      }

    } catch (e) {
      setBadge("bad","âŒ è¿è¡Œå¼‚å¸¸");
      log("âŒ æ‹‰å–/è§£æå¼‚å¸¸ï¼š" + (e?.message || e));
    }
  }

  function start() {
    stop();

    localStorage.setItem(LS.betDigits, el.betDigits.value || "");
    localStorage.setItem(LS.feishuUrl, el.feishuUrl.value || "");
    localStorage.setItem(LS.intervalSec, el.intervalSec.value || "5");
    localStorage.setItem(LS.targetBall, el.targetBall.value || "A");

    const sec = Math.max(2, Number(el.intervalSec.value || "5"));
    setBadge("warn","â³ å¯åŠ¨ä¸­â€¦sâ€¦");
    log(`ğŸš€ å¯åŠ¨ï¼šæ¯ ${sec}s æ‹‰å–ä¸€æ¬¡`);
    tick();
    timer = setInterval(tick, sec * 1000);
  }

  function stop() {
    if (timer) clearInterval(timer);
    timer = null;
    setBadge("warn","ğŸ›‘ å·²åœæ­¢");
  }

  async function testPush() {
    const url = (el.feishuUrl.value || "").trim();
    if (!url) { log("ğŸš« è¯·å…ˆå¡«å†™é£ä¹¦ Webhook URL"); return; }
    const betSet = parseBetDigits(el.betDigits.value);
    const target = el.targetBall.value || "A";
    const sec = Math.max(2, Number(el.intervalSec.value || "5"));

    const msg =
`âœ…ã€æµ‹è¯•ã€‘PC28 ç›‘æ§æ­£å¸¸
ğŸ¯ ç›®æ ‡ï¼š${target}çƒ
ğŸ² æŠ•æ³¨é›†åˆï¼š${betSet.join("") || "-"}
â±ï¸ è½®è¯¢ï¼š${sec}s
è§¦å‘æ¡ä»¶ï¼š2è¿æŒ‚ â†’ æ¨é€ ğŸš¨`;

    try { await feishuPush(url, msg); log("ğŸ“¨ æµ‹è¯•æ¨é€æˆåŠŸ âœ…"); }
    catch (e) { log("âŒ æµ‹è¯•æ¨é€å¤±è´¥ï¼š" + (e?.message || e)); }
  }

  function resetLocal() {
    Object.values(LS).forEach(k => localStorage.removeItem(k));
    el.log.textContent = "";
    el.rawJson.textContent = "";
    el.issue.textContent = "-";
    el.opennum.textContent = "-";
    el.abc.textContent = "-";
    el.hit.textContent = "-";
    el.streak.textContent = "0";
    setBadge("warn","â™»ï¸ å·²æ¸…é™¤çŠ¶æ€");
    log("â™»ï¸ å·²æ¸…é™¤æœ¬åœ°çŠ¶æ€ï¼ˆè¿æŒ‚/æ¨é€è®°å½•/é…ç½®ï¼‰");
  }

  function loadConfig() {
    const bd = localStorage.getItem(LS.betDigits);
    const fu = localStorage.getItem(LS.feishuUrl);
    const it = localStorage.getItem(LS.intervalSec);
    const tb = localStorage.getItem(LS.targetBall);

    if (bd) el.betDigits.value = bd;
    if (fu) el.feishuUrl.value = fu;
    if (it) el.intervalSec.value = it;
    if (tb) el.targetBall.value = tb;

    el.streak.textContent = localStorage.getItem(LS.streak) || "0";
    el.targetShow.textContent = el.targetBall.value || "A";
  }

  el.startBtn.addEventListener("click", start);
  el.stopBtn.addEventListener("click", stop);
  el.testBtn.addEventListener("click", testPush);
  el.resetBtn.addEventListener("click", resetLocal);

  // ä¿å­˜å˜æ›´
  el.targetBall.addEventListener("change", () => {
    localStorage.setItem(LS.targetBall, el.targetBall.value || "A");
    el.targetShow.textContent = el.targetBall.value || "A";
  });

  loadConfig();
  setBadge("warn","â³ ç­‰å¾…å¯åŠ¨");
  log("âœ… é¡µé¢åŠ è½½å®Œæˆï¼šé»˜è®¤æŠ¼ A çƒã€‚ç‚¹å‡»ã€Œå¯åŠ¨ã€å¼€å§‹è¿è¡Œã€‚");
})();
</script>
</body>
</html>
